"use strict";(globalThis.webpackChunk=globalThis.webpackChunk||[]).push([["app_utils_discover_charts_tsx-app_views_starfish_modules_databaseModule_databaseTableView_tsx-463c2f"],{"./app/utils/discover/charts.tsx":(e,t,n)=>{n.d(t,{CX:()=>r,Xp:()=>d,gu:()=>o,x1:()=>l});var i=n("./app/locale.tsx"),s=n("./app/utils.tsx"),a=n("./app/utils/formatters.tsx");function r(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"number";return(0,s.ri)(e)?function(e,t){if(!(0,s.ri)(e))return"—";switch(t){case"integer":case"number":return e.toLocaleString();case"percentage":return(0,a.rl)(e,2);case"duration":return(0,a.g9)(e/1e3,2,!0);case"size":return(0,s.F)(e);default:return e.toString()}}(e,t):"—"}function o(e,t){return l(e,t,arguments.length>2&&void 0!==arguments[2]&&arguments[2],arguments.length>3?arguments[3]:void 0)}function l(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=arguments.length>3?arguments[3]:void 0;switch(t){case"integer":case"number":return n?(0,a.Du)(e):e.toLocaleString();case"percentage":return(0,a.rl)(e,0);case"duration":return function(e,t){if(t??=u(e),0===e)return"0";switch(t){case a.ps:{const t=(e/a.ps).toFixed(0);return(0,i.t)("%swk",t)}case a.x4:{const t=(e/a.x4).toFixed(0);return(0,i.t)("%sd",t)}case a.kr:{const t=(e/a.kr).toFixed(0);return(0,i.t)("%shr",t)}case a.EB:{const t=(e/a.EB).toFixed(0);return(0,i.t)("%smin",t)}case a.sh:{const t=(e/a.sh).toFixed(0);return(0,i.t)("%ss",t)}default:const t=e.toFixed(0);return(0,i.t)("%sms",t)}}(e,r);case"size":return(0,s.F)(e,0);default:return e.toString()}}function d(e,t){let n=0;const i=function(e,t){let n;if(e[0]?.data){let i,s=e[0];e.forEach(((n,a)=>{let{seriesName:r,data:o}=n;!1!==t?.selected?.[r]&&o.length&&(s=e[a],i??=e[a])})),i?.data&&(n={max:Math.max(...i.data.map((e=>{let{value:t}=e;return t})).filter((e=>!!e))),min:Math.min(...s.data.map((e=>{let{value:t}=e;return t})).filter((e=>!!e)))})}return n}(e,t);if(i){const e=(i.max+i.min)/2;n=u((i.max-i.min)/5),(e/n).toFixed(0).length>6&&(n=u(e))}return n}function u(e){return e>=a.ps?a.ps:e>=a.x4?a.x4:e>=a.kr?a.kr:e>=a.EB?a.EB:e>=a.sh?a.sh:1}},"./app/utils/discover/genericDiscoverQuery.tsx":(e,t,n)=>{n.d(t,{AA:()=>v,JC:()=>w,ZP:()=>b,o:()=>m});var i=n("../node_modules/@babel/runtime/helpers/esm/defineProperty.js"),s=(n("../node_modules/core-js/modules/es.error.cause.js"),n("../node_modules/react/index.js")),a=n("../node_modules/@tanstack/react-query/build/lib/useQuery.mjs"),r=n("./app/api.tsx"),o=n("./app/locale.tsx"),l=n("./app/utils/discover/eventView.tsx"),d=n("./app/utils/performance/contexts/performanceEventViewContext.tsx"),u=n("./app/views/organizationContext.tsx"),c=n("./app/utils/useApi.tsx"),p=n("../node_modules/@emotion/react/jsx-runtime/dist/emotion-react-jsx-runtime.browser.esm.js");class m{constructor(e,t){(0,i.Z)(this,"message",void 0),(0,i.Z)(this,"originalError",void 0),this.message=e,this.originalError=t}getOriginalError(){return this.originalError}}class h extends s.Component{constructor(){super(...arguments),(0,i.Z)(this,"state",{isLoading:!0,tableFetchID:void 0,error:null,tableData:null,pageLinks:null,api:new r.KU}),(0,i.Z)(this,"_shouldRefetchData",(e=>{const t=_(this.props),n=_(e);return!(0,l.ze)(t,n)||e.limit!==this.props.limit||e.route!==this.props.route||e.cursor!==this.props.cursor})),(0,i.Z)(this,"_parseError",(e=>{if(this.props.parseError)return this.props.parseError(e);if(!e)return null;const t=e.responseJSON?.detail;if("string"==typeof t)return new m(t,e);const n=t?.message;return new m("string"==typeof n?n:(0,o.t)("An unknown error occurred."),e)})),(0,i.Z)(this,"fetchData",(async()=>{const{queryBatching:e,beforeFetch:t,afterFetch:n,didFetch:i,eventView:s,orgSlug:a,route:r,setError:o}=this.props,{api:l}=this.state;if(!s.isValid())return;const d=`/organizations/${a}/${r}/`,u=Symbol("tableFetchID"),c=_(this.props);this.setState({isLoading:!0,tableFetchID:u}),o?.(void 0),t?.(l),l.clear();try{const[t,,s]=await v(l,d,c,{queryBatching:e});if(this.state.tableFetchID!==u)return;const a=n?n(t,this.props):t;i?.(a),this.setState((e=>({isLoading:!1,tableFetchID:void 0,error:null,pageLinks:s?.getResponseHeader("Link")??e.pageLinks,tableData:a})))}catch(e){const t=this._parseError(e);this.setState({isLoading:!1,tableFetchID:void 0,error:t,tableData:null}),o&&o(t??void 0)}}))}componentDidMount(){this.fetchData()}componentDidUpdate(e){const t=this._shouldRefetchData(e),n=!1===e.eventView.isValid()&&this.props.eventView.isValid(),i=!!this.props.shouldRefetchData&&this.props.shouldRefetchData(e,this.props);(t||n||i)&&this.fetchData()}render(){const{isLoading:e,error:t,tableData:n,pageLinks:i}=this.state,s={isLoading:e,error:t,tableData:n,pageLinks:i},a=this.props.children;return a?.(s)}}function y(e){const t=(0,s.useContext)(u.g)?.slug,n=(0,s.useContext)(d.uL)?.eventView,i=e.orgSlug??t,a=e.eventView??n;if(void 0===i||void 0===a)throw new Error("GenericDiscoverQuery requires both an orgSlug and eventView");const r={...e,orgSlug:i,eventView:a};return(0,p.tZ)(h,{...r})}h.displayName="_GenericDiscoverQuery",y.displayName="GenericDiscoverQuery";const f=200,g=2,x=e=>new Promise((t=>setTimeout(t,e)));async function v(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};const{queryBatching:s,retry:a}=i;if(s?.batchRequest)return s.batchRequest(e,t,{query:n,includeAllArgs:!0});const r=a?.baseTimeout??f,o=a?.timeoutMultiplier??g,l=a?.statusCodes??[],d=a?.tries??1;let u,c=0,p=0;for(;c<d&&(!u||l.includes(u.status));){p>0&&await x(p);try{return c++,await e.requestPromise(t,{method:"GET",includeAllArgs:!0,query:{...n}})}catch(e){u=e,p=r*o**(c-1)}}throw u}function _(e){const{cursor:t,limit:n,noPagination:i,referrer:s,getRequestPayload:a,eventView:r,location:o,forceAppendRawQueryString:l}=e,d=a?a(e):r.getEventsAPIPayload(o,l);return t&&(d.cursor=t),n&&(d.per_page=n),i&&(d.noPagination=i),s&&(d.referrer=s),Object.assign(d,e.queryExtras??{}),d}function w(e){const t=(0,c.Z)(),{orgSlug:n,route:i,options:s}=e,r=`/organizations/${n}/${i}/`,o=_(e);return(0,a.a)([i,o],(async()=>{const[n]=await v(t,r,o,{queryBatching:e.queryBatching});return n}),s)}const b=y},"./app/utils/performance/contexts/performanceEventViewContext.tsx":(e,t,n)=>{n.d(t,{bq:()=>s,uL:()=>r});var i=n("./app/utils/performance/contexts/utils.tsx");const[s,a,r]=(0,i.n)({name:"PerformanceEventViewContext"})},"./app/utils/performance/contexts/utils.tsx":(e,t,n)=>{n.d(t,{n:()=>s}),n("../node_modules/core-js/modules/es.error.cause.js");var i=n("../node_modules/react/index.js");function s(e){const{strict:t=!0,errorMessage:n=`useContext for "${e.name}" must be inside a Provider with a value`,name:s}=e,a=(0,i.createContext)(void 0);return a.displayName=s,[a.Provider,function(){const e=(0,i.useContext)(a);if(!e&&t)throw new Error(n);return e},a]}},"./app/views/starfish/components/sparkline.tsx":(e,t,n)=>{n.d(t,{Kv:()=>h,ZP:()=>m,Fk:()=>f,Ci:()=>y});var i=n("../node_modules/echarts/lib/chart/line/install.js"),s=n("../node_modules/echarts/lib/extension.js"),a=n("../node_modules/echarts/core.js"),r=n("../node_modules/zrender/lib/svg/Painter.js");function o(e){e.registerPainter("svg",r.Z)}var l=n("../node_modules/echarts-for-react/lib/core.js"),d=n("../node_modules/moment/moment.js"),u=n.n(d),c=n("./app/components/charts/components/markLine.tsx"),p=n("../node_modules/@emotion/react/jsx-runtime/dist/emotion-react-jsx-runtime.browser.esm.js");function m(e){let{series:t,width:n,color:r,markLine:d}=e;if(s.D([i.N,o]),!t.data)return null;const u={data:t.data.map((e=>e.value)),type:"line",showSymbol:!1,smooth:!0};return(0,p.tZ)(l.Z,{echarts:a,option:{color:r,series:[u,d],xAxis:{show:!1,data:t.data.map((e=>e.name)),type:"category"},yAxis:{show:!1,type:"value"},grid:{left:3,top:3,right:3,bottom:3}},notMerge:!0,style:{height:25,width:n??200},lazyUpdate:!0,theme:"theme_name"})}function h(e){let{series:t,markLine:n,width:r,height:d,color:u}=e;function c(e,t){return{data:e.data.map((e=>e.value)),type:"line",showSymbol:!1,smooth:!0,lineStyle:{color:u[t],width:[1,2][t]},yAxisIndex:t}}return s.D([i.N,o]),(0,p.tZ)(l.Z,{echarts:a,option:{series:[...t.map(((e,t)=>c(e,t))),n],xAxis:{show:!1,data:c(t[0],0).data.map((e=>e.name)),type:"category"},yAxis:[{show:!1,type:"value"},{show:!1,type:"value"}],grid:{left:3,top:3,right:3,bottom:3}},notMerge:!0,style:{height:d??25,width:r??200},lazyUpdate:!0,theme:"theme_name"})}function y(e,t,n,i){const s=n.findIndex((e=>Math.abs(u().duration(u()(e.name).diff(u()(t))).asSeconds())<86400));return{seriesName:e,type:"line",color:i.blue300,data:[],xAxisIndex:0,yAxisIndex:0,markLine:(0,c.Z)({silent:!0,animation:!1,lineStyle:{color:i.blue300,type:"dotted"},data:[{xAxis:s}],label:{show:!1}})}}function f(e,t,n){return{seriesName:e,type:"line",color:n.blue300,data:[],xAxisIndex:0,yAxisIndex:0,markLine:(0,c.Z)({silent:!0,animation:!1,lineStyle:{color:n.blue300,type:"dotted"},data:[{yAxis:t}],label:{show:!0,position:"insideStart",formatter:e}})}}m.displayName="Sparkline",h.displayName="MultiSparkline"},"./app/views/starfish/modules/databaseModule/databaseTableView.tsx":(e,t,n)=>{n.d(t,{Z:()=>g,h:()=>y});var i=n("../node_modules/@emotion/styled/base/dist/emotion-styled-base.browser.esm.js"),s=n("../node_modules/react/index.js"),a=n("../node_modules/@emotion/react/dist/emotion-element-6a883da9.browser.esm.js"),r=n("./app/components/badge.tsx"),o=n("./app/components/gridEditable/index.tsx"),l=n("./app/components/links/link.tsx"),d=n("./app/constants/chartPalette.tsx"),u=n("./app/styles/space.tsx"),c=n("./app/utils/formatters.tsx"),p=n("./app/views/starfish/components/sparkline.tsx"),m=n("./app/views/starfish/modules/databaseModule/panel/queryTransactionTable.tsx"),h=n("../node_modules/@emotion/react/jsx-runtime/dist/emotion-react-jsx-runtime.browser.esm.js");function y(e,t){if(e===t||void 0===t||void 0===e)return-1;const n=e.length<t.length?e.split(" "):t.split(" "),i=e.length>t.length?e.split(" "):t.split(" "),s=i.length;let a=0;for(;i.length>0;){const e=i.pop();e&&n.includes(e)&&(a+=1,n.splice(n.indexOf(e),1))}return a/s}function f(e,t){const n=y(t?.description,e.description)>.8,i=1===e?.newish,s=1===e?.retired;let a=null;return n?a=i&&1!==t.newish?(0,h.BX)("span",{children:[(0,h.tZ)(x,{type:"new",text:"new"}),(0,h.tZ)(x,{type:"alpha",text:"similar"})]}):s&&1!==t.retired?(0,h.BX)("span",{children:[(0,h.tZ)(x,{type:"warning",text:"old"}),(0,h.tZ)(x,{type:"alpha",text:"similar"})]}):(0,h.tZ)(x,{type:"alpha",text:"similar"}):i?a=(0,h.tZ)(x,{type:"new",text:"new"}):s&&(a=(0,h.tZ)(x,{type:"warning",text:"old"})),a}function g(e){let{location:t,data:n,onSelect:i,p95asNumber:r,noP95:u,onSortChange:y,selectedRow:g,isDataLoading:x,columns:w}=e;const[b,$]=(0,s.useState)({direction:void 0,sortHeader:void 0}),D=(0,a.u)();let q=[{key:"description",name:"Query",width:550},{key:"domain",name:"Table",width:175},{key:"epm",name:"Throughput (SPM)",width:175},{key:"p50",name:"P50",width:175},{key:"p95",name:"P95",width:r?void 0:175},{key:"transactions",name:"transactions"},{key:"total_time",name:"Total Time"}];return u&&(q=q.filter((e=>"p95"!==e.key))),(0,h.tZ)(o.ZP,{isLoading:x,data:n,columnOrder:w??q,columnSortBy:[],grid:{renderHeadCell:function(e){if(["p50","p95","epm","total_time","domain","transactions"].includes(e.key)){const t=e.key===b.sortHeader?.key?b.direction:void 0;return(0,h.tZ)(m.U,{onClick:()=>function(e){let t;b.direction&&e.key===b.sortHeader?.key?"desc"===b.direction&&(t="asc"):t="desc",y&&($({direction:t,sortHeader:e}),y({direction:t,sortHeader:e}))}(e),direction:t,title:e.name})}return(0,h.tZ)("span",{children:e.name})},renderBodyCell:function(e,t,n){const{key:s}=e,a=g?.group_id===t.group_id?{fontWeight:"bold"}:void 0;if("description"===s){const e=t.description;return(0,h.BX)(l.Z,{onClick:()=>i(t,n),to:"",style:a,children:[e.substring(0,30),e.length>30?"...":"",e.length>30?e.substring(e.length-30):"",f(t,g)]})}if("epm"===s){const n=(0,p.Fk)("",t.epm,D);return(0,h.BX)(_,{children:[(0,h.tZ)("span",{style:a,children:t.epm.toFixed(2)}),(0,h.tZ)(v,{children:(0,h.tZ)(p.ZP,{color:d.$[3][0],series:t.throughput,markLine:n,width:e.width?e.width-e.width/5-50:void 0})})]})}if("p50"===s){const n=(0,p.Fk)("",t.p50,D);return(0,h.BX)(_,{children:[(0,h.tZ)("span",{style:a,children:(0,c.g9)(t.p50/1e3,2,!0)}),(0,h.tZ)(v,{children:(0,h.tZ)(p.ZP,{color:d.$[3][1],series:t.p50_trend,markLine:n,width:e.width?e.width-e.width/5-50:void 0})})]})}if("p95"===s){const n=(0,p.Fk)("",t.p95,D);return(0,h.BX)(_,{children:[(0,h.tZ)("span",{style:a,children:(0,c.g9)(t.p95/1e3,2,!0)}),(0,h.tZ)(v,{children:!r&&(0,h.tZ)(p.ZP,{color:d.$[3][2],series:t.p95_trend,markLine:n,width:e.width?e.width-e.width/5-50:void 0})})]})}return"total_time"===s?(0,h.tZ)("span",{style:a,children:(0,c.g9)(t.total_time/1e3,2,!0)}):(0,h.tZ)("span",{style:a,children:t[s]})}},location:t})}g.displayName="DatabaseTableView";const x=(0,i.Z)(r.Z,{target:"eejlxta2"})("margin-left:",(0,u.D)(.75),";"),v=(0,i.Z)("div",{target:"eejlxta1"})({name:"1o3nkn",styles:"margin-left:auto"}),_=(0,i.Z)("div",{target:"eejlxta0"})({name:"1lv1yo7",styles:"display:inline-flex"})},"./app/views/starfish/modules/databaseModule/panel/queryTransactionTable.tsx":(e,t,n)=>{n.d(t,{U:()=>g,Z:()=>w});var i=n("../node_modules/@emotion/styled/base/dist/emotion-styled-base.browser.esm.js"),s=n("../node_modules/react/index.js"),a=n("../node_modules/@emotion/react/dist/emotion-element-6a883da9.browser.esm.js"),r=n("../node_modules/query-string/index.js"),o=n("./app/components/gridEditable/index.tsx"),l=n("./app/components/links/link.tsx"),d=n("./app/components/truncate.tsx"),u=n("./app/constants/chartPalette.tsx"),c=n("./app/icons/index.tsx"),p=n("./app/utils/useLocation.tsx"),m=n("./app/views/starfish/components/sparkline.tsx"),h=n("../node_modules/@emotion/react/jsx-runtime/dist/emotion-react-jsx-runtime.browser.esm.js");const y=[{key:"transaction",name:"Transaction",width:400},{key:"spm",name:"TPM v SPM",width:200},{key:"p50",name:"Span p50 vs Txn p50",width:200}];function f(e){const{isDataLoading:t,tableData:n,sort:i,onClickSort:c,row:f,spmData:v,tpmData:_,spanP50Data:w,txnP50Data:b,markLine:$}=e,D=(0,p.T)(),q=(0,a.u)(),Z=x(n);return(0,h.tZ)(o.ZP,{isLoading:t,data:n,columnOrder:y,columnSortBy:[],grid:{renderHeadCell:e=>{const{key:t,name:n}=e;if(["p50","spm"].includes(t)){const t=e.key===i.sortHeader?.key?i.direction:void 0;return(0,h.tZ)(g,{onClick:()=>(e=>{let t;i.direction&&e.key===i.sortHeader?.key?"desc"===i.direction&&(t="asc"):t="desc",c({direction:t,sortHeader:e})})(e),direction:t,title:n})}return(0,h.tZ)("span",{children:n})},renderBodyCell:(e,t)=>((e,t)=>{const{key:n}=e,i=t[n],a={"min-height":"40px"};Z[n]&&(i>Z[n].max||i<Z[n].min)&&(a.color=q.red400);const o=v.length&&v.find((e=>e.seriesName===t.transaction)),c=_.length&&_.find((e=>e.seriesName===t.transaction)),p=w.length&&w.find((e=>e.seriesName===t.transaction)),y=b.length&&b.find((e=>e.seriesName===t.transaction));return"spm"===n&&o&&c?(0,h.tZ)(m.Kv,{color:[u.$[4][0],u.$[4][3]],series:[o,c],markLine:$,width:e.width?e.width-e.width/5:void 0,height:40}):"transaction"===n?(0,h.BX)(s.Fragment,{children:[(0,h.tZ)(l.Z,{to:`/starfish/span/${encodeURIComponent(f.group_id)}?${r.stringify({transaction:t.transaction})}`,children:(0,h.tZ)(d.Z,{value:t[e.key],maxLength:50})}),(0,h.BX)("span",{children:["Span appears ",t.frequency?.toFixed(2),"x per txn (",t.uniqueEvents," ","total txns)"]}),(0,h.tZ)(l.Z,{to:`/performance/sentry:${t.example}/`,children:"sample"})]}):"p50"===n&&p&&y?(0,h.tZ)(m.Kv,{color:[u.$[4][0],u.$[4][2]],series:[p,y],markLine:$,width:e.width?e.width-e.width/5:void 0}):(0,h.tZ)("span",{style:a,children:t[n]})})(e,t)},location:D})}function g(e){let{title:t,direction:n,onClick:i}=e;const s=n?(0,h.tZ)(_,{size:"xs",direction:"desc"===n?"down":"up"}):null;return(0,h.BX)(v,{onClick:i,children:[t," ",s]})}f.displayName="QueryTransactionTable",g.displayName="SortableHeader";const x=e=>{const t={};return e.length>0&&Object.entries(e[0]).forEach((n=>{let[i,s]=n;"number"==typeof s&&(t[i]=function(e,t){const n=[...e].sort(((e,n)=>e[t]-n[t]));if(e.length<4)return{min:e[0][t],max:e[e.length-1][t]};const i=n[Math.floor(n.length*(1/4))][t],s=n[Math.ceil(n.length*(3/4))][t],a=s-i;return{min:i-1.5*a,max:s+1.5*a}}(e,i))})),t},v=(0,i.Z)("div",{target:"e1pxi4w71"})({name:"e0dnmk",styles:"cursor:pointer"}),_=(0,i.Z)(c.CC,{target:"e1pxi4w70"})({name:"40f4ru",styles:"vertical-align:top"}),w=f},"./app/views/starfish/modules/databaseModule/queries.ts":(e,t,n)=>{n.d(t,{$R:()=>Z,Ep:()=>S,OJ:()=>v,Tu:()=>E,W3:()=>$,Yy:()=>q,_y:()=>_,c0:()=>w,gy:()=>D,mi:()=>b,rq:()=>x,uU:()=>M,uw:()=>k,zD:()=>T}),n("../node_modules/core-js/modules/es.array.push.js");var i=n("../node_modules/moment/moment.js"),s=n("./app/utils/discover/discoverQuery.tsx"),a=n("./app/utils/discover/eventView.tsx"),r=(n("./app/utils/discover/genericDiscoverQuery.tsx"),n("./app/utils/discover/types.tsx")),o=n("./app/utils/queryClient.tsx"),l=n("./app/utils/useLocation.tsx"),d=n("./app/utils/useOrganization.tsx"),u=n("./app/utils/usePageFilters.tsx"),c=n("./app/views/starfish/utils/constants.tsx"),p=n("./app/views/starfish/utils/dates.tsx"),m=n("./app/views/starfish/utils/useSpansQuery.tsx");const h="\n  startsWith(span_operation, 'db') and\n  span_operation != 'db.redis' and\n  module = 'db' and\n  action != ''\n",y="if(duration > 0, divide(count(), (max(start_timestamp) - min(start_timestamp) as duration)/60), 0)",f="\n  -sum(exclusive_time), -count()\n",g=604800,x=()=>{const e=(0,u.Z)(),{startTime:t,endTime:n}=(0,p.tZ)(e),i=T(t,n),s=`\n  select\n    domain as key,\n    quantile(0.75)(exclusive_time) as value\n  from default.spans_experimental_starfish\n  where\n    ${h}\n    ${i}\n  group by domain\n  order by ${f}\n  `;return(0,o.aM)({queryKey:["table",e.selection.datetime],queryFn:()=>fetch(`${c.M}/?query=${s}`).then((e=>e.json())),retry:!1,initialData:[]})},v=e=>{const t=(0,u.Z)(),{startTime:n,endTime:i}=(0,p.tZ)(t),s=T(n,i),a=`\n  select\n    floor(quantile(0.50)(exclusive_time), 5) as p50,\n    action,\n    count() as count,\n    toStartOfInterval(start_timestamp, INTERVAL ${e} hour) as interval\n  from default.spans_experimental_starfish\n  where\n    ${h}\n    ${s} and\n    action in (${r=s,`\n  select action\n  from default.spans_experimental_starfish\n  where\n    ${h}\n    ${r}\n  group by action\n  order by ${f}\n  limit 5\n  `})\n  group by action, interval\n  order by action, interval\n  `;var r;return(0,o.aM)({queryKey:["topGraph",t.selection.datetime],queryFn:()=>fetch(`${c.M}/?query=${a}`).then((e=>e.json())),retry:!1,initialData:[]})},_=e=>{const t=(0,u.Z)(),{startTime:n,endTime:i}=(0,p.tZ)(t),s=T(n,i),a=`\n  select\n    floor(quantile(0.50)(exclusive_time), 5) as p50,\n    domain,\n    divide(count(), multiply(${e}, 60)) as count,\n    toStartOfInterval(start_timestamp, INTERVAL ${e} hour) as interval\n  from default.spans_experimental_starfish\n  where\n    ${h}\n    ${s} and\n    domain in (${r=s,`\n  select domain\n  from default.spans_experimental_starfish\n  where\n    ${h}\n    ${r} and\n    domain != ''\n  group by domain\n  having\n    ${y} > 0.05\n  order by ${f}\n  limit 5\n  `})\n  group by interval, domain\n  order by interval, domain\n  `;var r;const l=(0,o.aM)({queryKey:["topTable",t.selection.datetime],queryFn:()=>fetch(`${c.M}/?query=${a}`).then((e=>e.json())),retry:!1,initialData:[]}),d=`\n  select\n  floor(quantile(0.50)(exclusive_time), 5) as p50,\n  divide(count(), multiply(${e}, 60)) as count,\n  toStartOfInterval(start_timestamp, INTERVAL ${e} hour) as interval\n  from default.spans_experimental_starfish\n  where\n    domain not in ('${[...new Set(l.data.map((e=>e.domain)))].join("', '")}')\n    AND ${h}\n    ${s}\n  group by interval\n  order by interval\n  `,m=(0,o.aM)({enabled:!l.isLoading&&!!l.data?.length,queryKey:["topTableOther",t.selection.datetime],queryFn:()=>fetch(`${c.M}/?query=${d}`).then((e=>e.json())),retry:!1,initialData:[]});m.data.forEach((e=>e.domain="other"));const g=[...l.data,...m.data];return{...m,data:g}},w=(e,t,n,i)=>{const s=(0,u.Z)(),{startTime:a,endTime:r}=(0,p.tZ)(s),l=T(a,r),d=j(t,n)??f,m=i?`and transaction='${i}'`:"",y=`\n    SELECT\n      transaction,\n      count() AS count,\n      quantile(0.75)(exclusive_time) as p75,\n      any(transaction_id) as example\n    FROM spans_experimental_starfish\n    WHERE\n      ${h}\n      ${l} AND\n      group_id = '${e.group_id}'\n      ${m}\n    GROUP BY transaction\n    ORDER BY ${d}\n    LIMIT 5\n  `;return(0,o.aM)({queryKey:["dbQueryDetailsTable",e.group_id,s.selection.datetime,t,n],queryFn:()=>fetch(`${c.M}/?query=${y}`).then((e=>e.json())),retry:!0,initialData:[]})},b=e=>{const t=(0,u.Z)(),{startTime:n,endTime:i}=(0,p.tZ)(t),s=T(n,i),a=`\n    SELECT\n      minIf(transaction_id, equals(timestamp, '${e.lastSeen}')) as latest,\n      minIf(transaction_id, equals(timestamp, '${e.firstSeen}')) as first\n    FROM spans_experimental_starfish\n    WHERE\n      ${h}\n      ${s} AND\n      group_id = '${e.group_id}'\n    HAVING latest > 0 and first > 0\n    LIMIT 10\n  `;return(0,o.aM)({queryKey:["getExampleTransaction",e.group_id],queryFn:()=>fetch(`${c.M}/?query=${a}`).then((e=>e.json())),retry:!0,initialData:[]})},$=(e,t,n,i,s)=>{const a=(0,u.Z)(),{startTime:r,endTime:l}=(0,p.tZ)(a),d=T(r,l),m=j(t,n)??f,y=s?`and transaction='${s}'`:"",g=`\n    SELECT\n      transaction,\n      toStartOfInterval(start_timestamp, INTERVAL ${i} hour) as interval,\n      quantile(0.50)(exclusive_time) AS p50,\n      divide(count(), multiply(${i}, 60)) as spm\n    FROM spans_experimental_starfish\n    WHERE\n      transaction in (\n        SELECT\n          transaction\n        FROM spans_experimental_starfish\n        WHERE\n          ${h}\n          ${d} AND\n          group_id = '${e.group_id}'\n          ${y}\n        GROUP BY transaction\n        ORDER BY ${m}\n        LIMIT 5\n      ) and\n      ${h}\n      ${d} AND\n      group_id = '${e.group_id}'\n    GROUP BY transaction, interval\n    ORDER BY transaction, interval, ${m}\n  `;return(0,o.aM)({queryKey:["dbQueryDetailsSparklines",e.group_id,a.selection.datetime,t,n],queryFn:()=>fetch(`${c.M}/?query=${g}`).then((e=>e.json())),retry:!0,initialData:[]})},D=(e,t)=>{const n=(0,u.Z)(),{startTime:i,endTime:s}=(0,p.tZ)(n),a=T(i,s),r=`\n    SELECT\n      toStartOfInterval(start_timestamp, INTERVAL ${t} HOUR) as interval,\n      quantile(0.95)(exclusive_time) as p95,\n      quantile(0.50)(exclusive_time) as p50,\n      divide(count(), multiply(${t}, 60)) as count\n    FROM spans_experimental_starfish\n    WHERE\n      ${h}\n      ${a} AND\n      group_id = '${e.group_id}'\n    GROUP BY interval\n    ORDER BY interval\n  `;return(0,o.aM)({queryKey:["dbQueryDetailsGraph",e.group_id,n.selection.datetime],queryFn:()=>fetch(`${c.M}/?query=${r}&format=sql`).then((e=>e.json())),retry:!1,initialData:[]})},q=e=>{const t=(0,u.Z)(),{startTime:n,endTime:i}=(0,p.tZ)(t),s=T(n,i),a=`\n    SELECT\n      transaction,\n      count(DISTINCT transaction_id) as uniqueEvents\n    FROM spans_experimental_starfish\n    WHERE\n      ${h}\n      ${s} AND\n      group_id = '${e.group_id}'\n    GROUP BY transaction\n    ORDER BY ${f}\n   `;return(0,o.aM)({queryKey:["dbQueryDetailsEventCount",e.group_id,t.selection.datetime],queryFn:()=>fetch(`${c.M}/?query=${a}`).then((e=>e.json())),retry:!0,initialData:[]})},Z=e=>{const{action:t,filterNew:n,filterOld:s,filterOutlier:a,sortDirection:r,sortKey:l,table:d,transaction:m,limit:x}=e,v=(0,u.Z)(),{startTime:_,endTime:w}=(0,p.tZ)(v),b=T(_,w),$=n?"newish = 1":void 0,D=s?"retired = 1":void 0,q=a?`${y} > 0.02`:void 0,Z=[h,m?`transaction='${m}'`:null,d&&"ALL"!==d?`domain = '${d}'`:void 0,t&&"ALL"!==t?`action = '${t}'`:void 0].filter((e=>!!e)),E=w.unix()-_.unix(),k=((e,t,n)=>{const{start_timestamp:s,end_timestamp:a}=(0,p.SW)({start:(0,i.unix)(t.unix()+e/10).format("YYYY-MM-DD HH:mm:ss"),end:(0,i.unix)(n.unix()-e/10).format("YYYY-MM-DD HH:mm:ss")});return e>g?`(\n        greater(min(start_timestamp), '${s}') and\n        greater(max(start_timestamp), '${a}')\n      ) as newish`:"0 as newish"})(E,_,w),S=((e,t,n)=>{const{start_timestamp:s,end_timestamp:a}=(0,p.SW)({start:(0,i.unix)(t.unix()+e/10).format("YYYY-MM-DD HH:mm:ss"),end:(0,i.unix)(n.unix()-e/10).format("YYYY-MM-DD HH:mm:ss")});return e>g?`(\n        less(max(start_timestamp), '${a}') and\n        less(min(start_timestamp), '${s}')\n      ) as retired`:"0 as retired"})(E,_,w),M=[$,D,q].filter((e=>!!e)),L=j(l,r)??f,A=`\n  select\n    description,\n    group_id, count() as count,\n    ${y} as epm,\n    quantile(0.75)(exclusive_time) as p75,\n    quantile(0.50)(exclusive_time) as p50,\n    quantile(0.95)(exclusive_time) as p95,\n    uniq(transaction) as transactions,\n    sum(exclusive_time) as total_time,\n    domain,\n    action,\n    data_keys,\n    data_values,\n    min(start_timestamp) as firstSeen,\n    max(start_timestamp) as lastSeen,\n    ${k},\n    ${S}\n  from default.spans_experimental_starfish\n  where\n    ${Z.join(" AND ")}\n    ${b}\n  group by\n    action,\n    description,\n    group_id,\n    domain,\n    data_keys,\n    data_values\n  ${M.length>0?"having":""}\n    ${M.join(" and ")}\n  order by ${L}\n  limit ${x??50}\n`;return(0,o.aM)({queryKey:["endpoints",m,d,v.selection.datetime,l,r,$,D,q],cacheTime:1e4,queryFn:()=>fetch(`${c.M}/?query=${A}&format=sql`).then((e=>e.json())),retry:!1,initialData:[]})},E=(e,t)=>{const{selection:{datetime:n}}=(0,u.Z)();return(0,m.Y7)({eventView:a.ZP.fromSavedQuery({name:"",fields:["transaction","epm()","p50(transaction.duration)","p95(transaction.duration)"],yAxis:["epm()","p50(transaction.duration)","p95(transaction.duration)"],orderby:"-count",query:`transaction:["${e.join('","')}"]`,topEvents:"5",start:n.start,end:n.end,range:n.period,dataset:r.as.METRICS,interval:`${t}h`,projects:[1],version:2}),initialData:[]})},k=e=>{const t=(0,l.T)(),{slug:n}=(0,d.Z)(),i=a.ZP.fromNewQueryWithLocation({fields:["transaction"],name:"Db module - profile",query:`transaction:[${e.join(",")}] has:profile.id`,projects:[1],version:1,orderby:"id"},t);return(0,s._)({eventView:i,location:t,orgSlug:n,queryExtras:{per_page:"10"}})},S=e=>{const t=`/api/0/projects/sentry/sentry/events/${e?.replaceAll("-","")}/`;return(0,o.aM)({enabled:!!e,queryKey:["event",e],queryFn:()=>fetch(t).then((e=>e.json())),retry:!1,initialData:{}})},j=(e,t)=>{if(t&&e)return t??="",`${e} ${t}`},T=(e,t)=>{const{start_timestamp:n,end_timestamp:i}=(0,p.SW)({start:e.format("YYYY-MM-DD HH:mm:ss"),end:t.format("YYYY-MM-DD HH:mm:ss")});return`\n  ${n?`AND greaterOrEquals(start_timestamp, '${n}')`:""}\n  ${i?`AND lessOrEquals(start_timestamp, '${i}')`:""}\n  `},M=e=>{let{datetime:t,transaction:n}=e;const{start_timestamp:i,end_timestamp:s}=(0,p.SW)(t);return`\n    SELECT\n    description,\n    toStartOfInterval(start_timestamp, INTERVAL 12 HOUR) as interval,\n    divide(count(), multiply(12, 60)) as count,\n    quantile(0.50)(exclusive_time) as p50,\n    quantile(0.95)(exclusive_time) as p95\n    FROM spans_experimental_starfish\n    WHERE module = 'db'\n    ${n?`AND transaction = '${n}'`:""}\n    ${i?`AND greaterOrEquals(start_timestamp, '${i}')`:""}\n    ${s?`AND lessOrEquals(start_timestamp, '${s}')`:""}\n    GROUP BY description, interval\n    ORDER BY interval asc\n  `}},"./app/views/starfish/utils/constants.tsx":(e,t,n)=>{n.d(t,{M:()=>i});const i="http://localhost:8080"},"./app/views/starfish/utils/useSpansQuery.tsx":(e,t,n)=>{n.d(t,{bB:()=>h,Y7:()=>f}),n("../node_modules/core-js/modules/es.error.cause.js"),n("../node_modules/core-js/modules/es.array.push.js");var i=n("../node_modules/@tanstack/react-query/build/lib/useQuery.mjs"),s=n("../node_modules/moment/moment.js"),a=n.n(s),r=n("./app/utils/discover/discoverQuery.tsx"),o=n("./app/utils/discover/eventView.tsx"),l=n("./app/utils/discover/genericDiscoverQuery.tsx"),d=n("./app/utils/useLocation.tsx"),u=n("./app/utils/useOrganization.tsx"),c=n("./app/views/starfish/utils/constants.tsx"),p=n("../node_modules/react/index.js");const m="YYYY-MM-DDTHH:mm:ss";function h(e){let{eventView:t,queryString:n,initialData:i,forceUseDiscover:s,enabled:a}=e;const{options:r}=function(){const[e,t]=(0,p.useState)({useDiscover:!1});return{options:e,setOptions:t}}(),{useDiscover:o}=r,l=function(e){let{useDiscover:t,isTimeseriesQuery:n}=e;return t?n?f:g:y}({useDiscover:s??o,isTimeseriesQuery:(t?.yAxis?.length??0)>0});if(function(e){return e===g}(l)||function(e){return e===f}(l)){if(t)return l({eventView:t,initialData:i,enabled:a});throw new Error("eventView argument must be defined when Starfish useDiscover is true")}if(n)return l({queryString:n,initialData:i,enabled:a});throw new Error("queryString argument must be defined when Starfish useDiscover is false, ie when using scraped data via fetch API")}function y(e){let{queryString:t,initialData:n,enabled:s}=e;const{isLoading:a,data:r}=(0,i.a)({queryKey:[t],queryFn:()=>fetch(`${c.M}/?query=${t}`).then((e=>e.json())),retry:!1,initialData:n,enabled:s,refetchOnWindowFocus:!1});return{isLoading:a,data:r}}function f(e){let{eventView:t,enabled:n,initialData:i}=e;const s=(0,d.T)(),a=(0,u.Z)(),{isLoading:r,data:c}=(0,l.JC)({route:"events-stats",eventView:t,location:s,orgSlug:a.slug,getRequestPayload:()=>({...t.getEventsAPIPayload(s),yAxis:t.yAxis,topEvents:t.topEvents,excludeOther:1,partial:1,orderby:t.sorts?.[0]?(0,o.uZ)(t.sorts?.[0]):void 0,interval:t.interval}),options:{enabled:n,refetchOnWindowFocus:!1}});return{isLoading:r,data:r&&i?i:x(c,t)}}function g(e){let{eventView:t,initialData:n}=e;const i=(0,d.T)(),s=(0,u.Z)(),{isLoading:a,data:o}=(0,r._)({eventView:t,orgSlug:s.slug,location:i});return{isLoading:a,data:a&&n?n:o?.data}}function x(e,t){if(!t.yAxis)return[];let n=[];const i=t.yAxis&&("string"==typeof t.yAxis||1===t.yAxis.length),s="string"==typeof t.yAxis?t.yAxis:t.yAxis[0];return e.data?v(e,i?s:"count"):(Object.keys(e).forEach((t=>{e[t].data?n=_(n,v(e[t],i?s:t)):Object.keys(e[t]).forEach((i=>{"order"!==i&&(n=_(n,v(e[t][i],i,t)))}))})),n.map((e=>({...e,interval:a()(1e3*parseInt(e.interval,10)).format(m)}))))}function v(e,t,n){const i=[];return e.data.forEach((e=>{let[s,[{count:a}]]=e;const r=i.find((e=>e.interval===s&&(!n||e.group===n)));r?r[t]=a:i.push({interval:s,[t]:a,group:n})})),i}function _(e,t){const n=JSON.parse(JSON.stringify(e));return t.forEach((e=>{let{interval:t,group:i,...s}=e;const a=n.find((e=>e.interval===t&&(!i||e.group===i)));a?Object.keys(s).forEach((e=>{a[e]=s[e]})):n.push({interval:t,group:i,...s})})),n}}}]);
//# sourceMappingURL=../sourcemaps/app_utils_discover_charts_tsx-app_views_starfish_modules_databaseModule_databaseTableView_tsx-463c2f.0d78c36acb6c6205bab5b24cd7fb9004.js.map