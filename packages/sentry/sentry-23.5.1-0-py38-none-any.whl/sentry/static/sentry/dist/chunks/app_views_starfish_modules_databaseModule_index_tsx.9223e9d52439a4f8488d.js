"use strict";(globalThis.webpackChunk=globalThis.webpackChunk||[]).push([["app_views_starfish_modules_databaseModule_index_tsx"],{"./app/components/performance/searchBar.tsx":(e,t,a)=>{a.d(t,{D:()=>j,Z:()=>D});var s=a("../node_modules/@emotion/styled/base/dist/emotion-styled-base.browser.esm.js"),n=(a("../node_modules/core-js/modules/es.array.push.js"),a("../node_modules/core-js/modules/es.error.cause.js"),a("../node_modules/react/index.js")),i=a("../node_modules/react-router/es/index.js"),r=a("../node_modules/lodash/debounce.js"),o=a.n(r),l=a("./app/components/searchBar.tsx"),c=a("./app/components/smartSearchBar/utils.tsx"),d=a("./app/constants/index.tsx"),p=a("./app/locale.tsx"),u=a("./app/utils/discover/genericDiscoverQuery.tsx"),m=a("./app/utils/tokenizeSearch.tsx"),h=a("./app/utils/useApi.tsx"),g=a("./app/utils/useOnClickOutside.tsx"),x=a("./app/utils/withDomainRequired.tsx"),f=a("./app/views/performance/transactionSummary/utils.tsx"),v=a("./app/components/smartSearchBar/searchDropdown.tsx"),b=a("./app/components/smartSearchBar/types.tsx"),Z=a("../node_modules/@emotion/react/jsx-runtime/dist/emotion-react-jsx-runtime.browser.esm.js");function w(e){const{organization:t,eventView:a,onSearch:s,query:r,className:w}=e,[D,k]=(0,n.useState)([]),C=D[0]?.children?.length||0,[T,B]=(0,n.useState)(-1),[z,L]=(0,n.useState)(!1),N=()=>L(!1),[A,q]=(0,n.useState)(!1),[E,P]=(0,n.useState)(r),F=(0,n.useRef)(null);(0,g.Z)(F,(0,n.useCallback)(N,[]));const O=(0,h.Z)(),$=a.clone(),M=`/organizations/${t.slug}/events/`,R=$.project?.map(String),I=(0,n.useCallback)(o()((async e=>{try{q(!0);const t=new m.MY("");t.addFilterValues("transaction",[j(e)],!1),t.addFilterValues("event.type",["transaction"]),Object.keys(O.activeRequests).length&&O.clear();const[a]=await(0,u.AA)(O,M,{field:["transaction","project_id","count()"],project:R,sort:"-count()",query:t.formatString(),statsPeriod:$.statsPeriod,referrer:"api.performance.transaction-name-search-bar"}),s=a.data.reduce(((e,t)=>(e.children.push({value:y(t),title:t.transaction,type:b.q.LINK,desc:""}),e)),{title:"All Transactions",children:[],icon:null,type:"header"});B(-1),k([s])}catch(e){throw new Error("Unable to fetch event field values")}finally{q(!1)}}),d.Dk,{leading:!0}),[O,M,$.statsPeriod,R.join(",")]),V=e=>{const t=S(e);X(t.transaction,!1)},X=(e,t)=>{k([]),P(e),e=new m.MY(e).formatString(),s(e?t?e:`transaction:"${e}"`:""),N()};return(0,Z.BX)(_,{className:w||"","data-test-id":"transaction-search-bar",ref:F,children:[(0,Z.tZ)(l.Z,{placeholder:(0,p.t)("Search Transactions"),onChange:e=>{if(P(e),0===e.length&&s(""),e.length<3)return k([]),void N();L(!0),I(e)},onKeyDown:e=>{const{key:t}=e;if(!A)if("Escape"===t&&z)N();else{if(("ArrowUp"===t||"ArrowDown"===t)&&z&&C>0){const e=D[0].children[T],a=(T+C+("ArrowUp"===t?-1:1))%C;B(a);const s=D[0].children[a];let n=D;return e&&(n=(0,c.$l)(D,e,!1)),s&&(n=(0,c.$l)(n,s,!0)),void k(n)}if("Enter"===t){e.preventDefault();const t=D[0]?.children[T];t?.value?V(t.value):X(E,!0)}}},query:E}),z&&(0,Z.tZ)(v.Z,{maxMenuHeight:300,searchSubstring:E,loading:A,items:D,onClick:V,onIconClick:e=>{(e=>{const{transaction:a,project_id:s}=e,n=$.generateQueryStringObject();k([]);const r=(0,f.e1)({orgSlug:t.slug,transaction:a,projectID:String(s),query:n});i.browserHistory.push((0,x.D)(r))})(S(e))}})]})}w.displayName="SearchBar";const y=e=>`${e.transaction}:${e.project_id}`,S=e=>{const t=e.lastIndexOf(":");return{project_id:parseInt(e.slice(t+1),10),transaction:e.slice(0,t)}},j=e=>(e.startsWith("*")||(e="*"+e),e.endsWith("*")||(e+="*"),e),_=(0,s.Z)("div",{target:"efn8czs0"})({name:"bjn8wh",styles:"position:relative"}),D=w},"./app/components/searchBar.tsx":(e,t,a)=>{a.d(t,{Z:()=>x,p:()=>g});var s=a("../node_modules/@emotion/styled/base/dist/emotion-styled-base.browser.esm.js"),n=a("../node_modules/react/index.js"),i=a("./app/components/button.tsx"),r=a("./app/components/inputGroup.tsx"),o=a("./app/icons/index.tsx"),l=a("./app/icons/iconClose.tsx"),c=a("./app/locale.tsx"),d=a("./app/styles/space.tsx"),p=a("../node_modules/@emotion/react/jsx-runtime/dist/emotion-react-jsx-runtime.browser.esm.js");function u(e){let{query:t,defaultQuery:a="",onChange:s,onSearch:i,width:d,size:u,className:x,trailing:f,...v}=e;const b=(0,n.useRef)(null),[Z,w]=(0,n.useState)(t??a);(0,n.useEffect)((()=>{"string"==typeof t&&w(t)}),[t]);const y=(0,n.useCallback)((e=>{const{value:t}=e.target;w(t),s?.(t)}),[s]),S=(0,n.useCallback)((e=>{e.preventDefault(),b.current?.blur(),i?.(Z)}),[i,Z]),j=(0,n.useCallback)((()=>{w(""),s?.(""),i?.("")}),[s,i]);return(0,p.tZ)(m,{onSubmit:S,className:x,children:(0,p.BX)(r.BZ,{children:[(0,p.tZ)(r.BZ.LeadingItems,{disablePointerEvents:!0,children:(0,p.tZ)(o.jV,{color:"subText",size:"xs"===u?"xs":"sm"})}),(0,p.tZ)(h,{...v,ref:b,type:"text",name:"query",autoComplete:"off",value:Z,onChange:y,width:d,size:u}),(0,p.BX)(r.BZ.TrailingItems,{children:[f,!!Z&&(0,p.tZ)(g,{size:"zero",borderless:!0,onClick:j,icon:(0,p.tZ)(l.b,{size:"xs"}),"aria-label":(0,c.t)("Clear")})]})]})})}u.displayName="SearchBar";const m=(0,s.Z)("form",{target:"elu65nr2"})({name:"4bgdod",styles:"display:block;position:relative"}),h=(0,s.Z)(r.BZ.Input,{target:"elu65nr1"})((e=>e.width&&`width: ${e.width};`),";"),g=(0,s.Z)(i.zx,{target:"elu65nr0"})("color:",(e=>e.theme.subText),";padding:",(0,d.D)(.5),";"),x=u},"./app/views/starfish/modules/databaseModule/index.tsx":(e,t,a)=>{a.r(t),a.d(t,{default:()=>M});var s=a("../node_modules/@emotion/styled/base/dist/emotion-styled-base.browser.esm.js"),n=a("../node_modules/react/index.js"),i=a("../node_modules/moment/moment.js"),r=a.n(i),o=a("./app/components/datePageFilter.tsx"),l=a("./app/components/layouts/thirds.tsx"),c=a("./app/components/organizations/pageFilters/parse.tsx"),d=a("./app/components/performance/searchBar.tsx"),p=a("./app/components/switchButton.tsx"),u=a("./app/locale.tsx"),m=a("./app/styles/space.tsx"),h=a("./app/utils/discover/eventView.tsx"),g=a("./app/utils/performance/contexts/pageError.tsx"),x=a("./app/utils/queryClient.tsx"),f=a("./app/utils/tokenizeSearch.tsx"),v=a("./app/utils/useLocation.tsx"),b=a("./app/utils/useOrganization.tsx"),Z=a("./app/utils/usePageFilters.tsx"),w=a("./app/views/starfish/modules/databaseModule/queries.ts"),y=a("./app/views/starfish/utils/combineTableDataWithSparklineData.tsx"),S=a("./app/views/starfish/utils/constants.tsx"),j=a("./app/views/starfish/utils/dates.tsx"),_=(a("../node_modules/core-js/modules/es.array.push.js"),a("../node_modules/@emotion/react/dist/emotion-element-6a883da9.browser.esm.js")),D=a("./app/components/compactSelect/index.tsx"),k=a("./app/utils/formatters.tsx"),C=a("./app/views/starfish/components/chart.tsx"),T=a("./app/views/starfish/components/chartPanel.tsx"),B=a("./app/views/starfish/utils/zeroFillSeries.tsx"),z=a("../node_modules/@emotion/react/jsx-runtime/dist/emotion-react-jsx-runtime.browser.esm.js");const L=12;function N(e,t){const a=(0,z.tZ)("span",{children:(0,u.t)("Operation")});return[{value:"ALL",prefix:a,label:"ALL"},...e.map((e=>({value:e.key,prefix:a,label:`${e.key||"null"} - ${(0,k.g9)(e.value/1e3,2,!0)} ${t}`})))]}function A(e){let{table:t,onChange:a}=e;const s=(0,Z.Z)(),i=(0,_.u)(),{start_timestamp:o,end_timestamp:l}=(0,j.SW)(s.selection.datetime),{data:c}=(0,w.rq)(),{isLoading:d,data:p}=(0,w.OJ)(L),{isLoading:m,data:h}=(0,w._y)(L),g={},x={};m||(h.forEach((e=>{g[e.domain]={seriesName:e.domain,data:[]},x[e.domain]={seriesName:e.domain,data:[]}})),h.forEach((e=>{g[e.domain].data.push({value:e.p50,name:e.interval}),x[e.domain].data.push({value:e.count,name:e.interval})})));const f=Object.values(g).map((e=>(0,B.b)(e,r().duration(L,"hours"),r()(o),r()(l)))),v=Object.values(x).map((e=>(0,B.b)(e,r().duration(L,"hours"),r()(o),r()(l)))),b={},y={};d||(p.forEach((e=>{y[e.action]={seriesName:e.action,data:[]},b[e.action]={seriesName:e.action,data:[]}})),p.forEach((e=>{y[e.action].data.push({value:e.p50,name:e.interval}),b[e.action].data.push({value:e.count,name:e.interval})})));const S=[...i.charts.getColorPalette(6).slice(2,7),i.gray300];return(0,C.K)([!m]),(0,z.tZ)(n.Fragment,{children:1===c.length&&""===c[0].key?(0,z.tZ)(n.Fragment,{}):(0,z.BX)(n.Fragment,{children:[(0,z.BX)(E,{children:[(0,z.tZ)(P,{children:(0,z.tZ)(T.Z,{title:(0,u.t)("Slowest Tables P50"),children:(0,z.tZ)(C.Z,{statsPeriod:"24h",height:180,data:f,start:"",end:"",chartColors:S,loading:m,utc:!1,grid:{left:"0",right:"0",top:"16px",bottom:"8px"},definedAxisTicks:4,isLineChart:!0,showLegend:!0})})}),(0,z.tZ)(P,{children:(0,z.tZ)(T.Z,{title:(0,u.t)("Table Throughput"),children:(0,z.tZ)(C.Z,{statsPeriod:"24h",height:180,data:v,start:"",end:"",chartColors:S,loading:d,utc:!1,grid:{left:"0",right:"0",top:"16px",bottom:"8px"},definedAxisTicks:4,showLegend:!0,isLineChart:!0})})})]}),(0,z.tZ)(q,{children:(0,z.tZ)(D.Z,{value:t,triggerProps:{prefix:(0,u.t)("Table")},options:N(c,"p50"),menuTitle:"Table",onChange:e=>a(e.value)})})]})})}A.displayName="DatabaseChartView";const q=(0,s.Z)("div",{target:"efxhah22"})("display:flex;margin-bottom:",(0,m.D)(2),";"),E=(0,s.Z)("div",{target:"efxhah21"})("display:flex;flex-direction:row;flex-wrap:wrap;gap:",(0,m.D)(2),";"),P=(0,s.Z)("div",{target:"efxhah20"})({name:"82a6rk",styles:"flex:1"});var F=a("./app/views/starfish/modules/databaseModule/databaseTableView.tsx"),O=a("./app/views/starfish/modules/databaseModule/panel/index.tsx");function $(){const e=(0,v.T)(),t=(0,b.Z)(),a=h.ZP.fromLocation(e),[s,i]=(0,n.useState)("ALL"),[p,m]=(0,n.useState)(!1),[_,D]=(0,n.useState)(!1),[k,C]=(0,n.useState)(!0),[T,B]=(0,n.useState)(""),[L,N]=(0,n.useState)({direction:void 0,sortHeader:void 0}),[q,E]=(0,n.useState)({selected:void 0,next:void 0,prev:void 0}),{isLoading:P,data:$,isRefetching:M}=(0,w.$R)({transaction:T,table:s,filterNew:p,filterOld:_,filterOutlier:k,sortKey:L.sortHeader?.key,sortDirection:L.direction}),X=(0,Z.Z)(),[W,K]=(0,n.useState)(!1),[Q,Y]=(0,n.useState)(!1),{selection:H}=X,{projects:U,environments:G,datetime:J}=H;(0,x.WE)([`/organizations/${t.slug}/events-starfish/`,{query:{environment:G,project:U.map((e=>String(e))),...(0,c.fK)(J)}}],{staleTime:10});const{data:ee}=(0,x.aM)({queryKey:["dbAggregates",T,p,_,X.selection.datetime],queryFn:()=>fetch(`${S.M}/?query=${(0,w.uU)({datetime:X.selection.datetime,transaction:T})}`).then((e=>e.json())),retry:!1,initialData:[]}),{start_timestamp:te,end_timestamp:ae}=(0,j.SW)(X.selection.datetime),se=(0,y.Z)($,ee,r().duration(12,"hours"),r()(te),r()(ae));(0,n.useEffect)((()=>{function e(e){let{keyCode:t}=e;E((e=>{if(e.selected){if(e.prev&&37===t)return ne(e.prev);if(e.next&&39===t)return ne(e.next)}return e}))}return document.addEventListener("keydown",e),function(){document.removeEventListener("keydown",e)}}),[$]);const ne=(e,t)=>{t??=$.findIndex((t=>t.group_id===e.group_id));const a=t>0?$[t-1]:void 0,s=t<$.length-1?$[t+1]:void 0;return{selected:e,next:s,prev:a}},ie=(e,t)=>{E(ne(e,t))};return(0,z.tZ)(l.T3,{children:(0,z.BX)(g.V_,{children:[(0,z.tZ)(l.h4,{children:(0,z.tZ)(l.oB,{children:(0,z.tZ)(l.Dx,{children:(0,u.t)("Database")})})}),(0,z.tZ)(l.uT,{children:(0,z.BX)(l.or,{fullWidth:!0,children:[(0,z.tZ)(g.YY,{}),(0,z.tZ)(R,{children:(0,z.tZ)(o.Z,{alignDropdown:"left"})}),(0,z.tZ)(A,{location:e,table:s,onChange:i}),(0,z.BX)(I,{children:[(0,z.tZ)(V,{label:"Filter New Queries",isActive:p,size:"lg",toggle:()=>{m(!p),p||D(!1)}}),(0,z.tZ)(V,{label:"Filter Old Queries",isActive:_,size:"lg",toggle:()=>{D(!_),_||m(!1)}}),(0,z.tZ)(V,{label:"Exclude Outliers",isActive:k,size:"lg",toggle:()=>{C(!k)}})]}),(0,z.tZ)(I,{children:(0,z.tZ)(d.Z,{organization:t,eventView:a,onSearch:e=>(e=>{const t=new f.MY(e),a=t.getFilterValues("transaction");a.length?B(a[0]):t.freeText.length>0?B(t.freeText.join(" ")):B("")})(e),query:T})}),(0,z.tZ)(F.Z,{location:e,data:se,isDataLoading:P||M,onSelect:ie,onSortChange:N,selectedRow:q.selected,p95asNumber:W,noP95:Q}),(0,z.tZ)(O.ZP,{isDataLoading:P||M,onRowChange:e=>{ie(e)},mainTableSort:L,row:q.selected,nextRow:q.next,prevRow:q.prev,onClose:()=>E({selected:void 0}),transaction:T}),(0,z.tZ)("div",{children:"Experiments"}),(0,z.tZ)(V,{label:"p95 as number",isActive:W,size:"lg",toggle:()=>{K(!W)}}),(0,z.tZ)(V,{label:"No p95",isActive:Q,size:"lg",toggle:()=>{Y(!Q)}})]})})]})})}$.displayName="DatabaseModule";const M=$,R=(0,s.Z)("div",{target:"e3mtf2m1"})("display:flex;flex-direction:row;gap:",(0,m.D)(1),";margin-bottom:",(0,m.D)(2),";"),I=(0,s.Z)("div",{target:"e3mtf2m0"})("margin-bottom:",(0,m.D)(2),";");function V(e){return(0,z.BX)("span",{style:{display:"inline-flex",gap:(0,m.D)(1),paddingRight:(0,m.D)(2),alignItems:"center"},children:[(0,z.tZ)("span",{children:e.label}),(0,z.tZ)(p.Z,{...e})]})}V.displayName="LabelledSwitch"},"./app/views/starfish/utils/combineTableDataWithSparklineData.tsx":(e,t,a)=>{a.d(t,{Z:()=>n}),a("../node_modules/core-js/modules/es.array.push.js");var s=a("./app/views/starfish/utils/zeroFillSeries.tsx");function n(e,t,a,n,i){const r={};return t.forEach((e=>{let{description:t,interval:a,count:s,p50:n,p95:i}=e;t in r?r[t].push({name:a,count:s,p50:n,p95:i}):r[t]=[{name:a,count:s,p50:n,p95:i}]})),e.map((e=>{const t=e.description,o={seriesName:"throughput",data:r[t]?.map((e=>{let{name:t,count:a}=e;return{name:t,value:a}}))},l={seriesName:"p50 Trend",data:r[t]?.map((e=>{let{name:t,p50:a}=e;return{name:t,value:a}}))},c={seriesName:"p95 Trend",data:r[t]?.map((e=>{let{name:t,p95:a}=e;return{name:t,value:a}}))},d=(0,s.b)(o,a,n,i),p=(0,s.b)(l,a,n,i),u=(0,s.b)(c,a,n,i);return{...e,throughput:d,p50_trend:p,p95_trend:u}}))}}}]);
//# sourceMappingURL=../sourcemaps/app_views_starfish_modules_databaseModule_index_tsx.ee352c3ad5d67cd0ecc5c78ecfe99196.js.map