import numpy as np
from legendtestdata import LegendTestData
from pytest import approx

import fcutils

ldata = LegendTestData()
ldata.checkout('49c7bdc')
wf_samples = [8148, 8154, 8146, 8131, 8148, 8139, 8141, 8154, 8175, 8168, 8163, 8155, 8174, 8155, 8157, 8172, 8156, 8164, 8151, 8151, 8137, 8147, 8157, 8162, 8164, 8176, 8191, 8177, 8156, 8154, 8158, 8166, 8164, 8139, 8165, 8172, 8162, 8154, 8177, 8173, 8178, 8176, 8173, 8176, 8179, 8177, 8193, 8188, 8186, 8173, 8179, 8170, 8160, 8157, 8150, 8161, 8145, 8142, 8155, 8181, 8159, 8163, 8164, 8155, 8156, 8153, 8142, 8150, 8150, 8157, 8156, 8161, 8173, 8169, 8170, 8165, 8156, 8145, 8162, 8158, 8152, 8157, 8142, 8159, 8162, 8141, 8148, 8134, 8141, 8127, 8132, 8130, 8125, 8146, 8151, 8158, 8155, 8137, 8169, 8154, 8164, 8164, 8156, 8150, 8144, 8136, 8151, 8130, 8151, 8152, 8172, 8151, 8159, 8161, 8169, 8172, 8184, 8171, 8180, 8190, 8181, 8168, 8163, 8171, 8163, 8147, 8160, 8144, 8159, 8158, 8145, 8174, 8156, 8160, 8156, 8171, 8132, 8128, 8136, 8135, 8134, 8147, 8179, 8161, 8168, 8149, 8150, 8164, 8131, 8141, 8158, 8169, 8154, 8136, 8153, 8163, 8156, 8138, 8138, 8149, 8141, 8144, 8143, 8166, 8185, 8159, 8171, 8181, 8175, 8165, 8157, 8154, 8162, 8160, 8146, 8146, 8139, 8172, 8174, 8147, 8144, 8149, 8154, 8139, 8140, 8134, 8146, 8146, 8153, 8145, 8152, 8168, 8165, 8157, 8173, 8183, 8163, 8158, 8178, 8155, 8151, 8159, 8169, 8155, 8142, 8126, 8142, 8129, 8156, 8170, 8168, 8166, 8163, 8159, 8169, 8167, 8176, 8183, 8172, 8171, 8167, 8171, 8181, 8164, 8161, 8158, 8179, 8153, 8148, 8144, 8151, 8148, 8129, 8145, 8161, 8164, 8166, 8161, 8153, 8160, 8185, 8178, 8164, 8170, 8162, 8149, 8135, 8152, 8156, 8139, 8154, 8163, 8167, 8159, 8188, 8162, 8166, 8163, 8157, 8151, 8147, 8153, 8145, 8159, 8167, 8148, 8156, 8125, 8135, 8150, 8154, 8145, 8166, 8151, 8146, 8142, 8158, 8144, 8155, 8167, 8152, 8152, 8155, 8152, 8167, 8156, 8179, 8170, 8169, 8161, 8152, 8142, 8140, 8126, 8143, 8137, 8153, 8137, 8156, 8145, 8127, 8112, 8145, 8153, 8179, 8147, 8147, 8148, 8168, 8164, 8155, 8150, 8165, 8155, 8163, 8167, 8154, 8155, 8151, 8169, 8142, 8148, 8162, 8164, 8170, 8154, 8171, 8153, 8158, 8148, 8161, 8173, 8180, 8171, 8158, 8164, 8150, 8156, 8134, 8148, 8136, 8144, 8154, 8157, 8176, 8159, 8176, 8171, 8150, 8151, 8154, 8161, 8156, 8164, 8160, 8150, 8139, 8134, 8145, 8151, 8159, 8159, 8163, 8135, 8134, 8131, 8128, 8136, 8131, 8151, 8153, 8149, 8129, 8146, 8145, 8138, 8138, 8140, 8151, 8172, 8154, 8156, 8142, 8136, 8163, 8151, 8160, 8171, 8151, 8146, 8151, 8161, 8131, 8119, 8138, 8158, 8172, 8146, 8155, 8151, 8161, 8167, 8140, 8143, 8144, 8155, 8164, 8178, 8151, 8161, 8157, 8160, 8124, 8121, 8146, 8137, 8141, 8152, 8142, 8147, 8142, 8135, 8133, 8144, 8160, 8148, 8150, 8146, 8150, 8148, 8147, 8152, 8161, 8141, 8150, 8160, 8156, 8158, 8139, 8164, 8156, 8151, 8146, 8147, 8153, 8140, 8161, 8173, 8170, 8166, 8166, 8178, 8155, 8150, 8155, 8144, 8145, 8158, 8159, 8160, 8167, 8187, 8178, 8179, 8156, 8171, 8171, 8191, 8168, 8152, 8157, 8168, 8161, 8139, 8163, 8144, 8153, 8153, 8151, 8143, 8141, 8156, 8168, 8185, 8195, 8178, 8169, 8172, 8190, 8170, 8166, 8154, 8145, 8155, 8149, 8126, 8115, 8148, 8163, 8130, 8150, 8173, 8167, 8148, 8148, 8158, 8165, 8170, 8180, 8162, 8165, 8172, 8159, 8150, 8146, 8159, 8158, 8159, 8160, 8142, 8154, 8152, 8152, 8168, 8160, 8133, 8137, 8151, 8153, 8148, 8160, 8151, 8146, 8141, 8131, 8144, 8141, 8149, 8148, 8129, 8129, 8134, 8139, 8146, 8161, 8140, 8176, 8182, 8179, 8175, 8155, 8162, 8145, 8159, 8164, 8152, 8128, 8157, 8161, 8172, 8158, 8146, 8147, 8173, 8155, 8155, 8152, 8158, 8148, 8162, 8158, 8153, 8142, 8142, 8152, 8146, 8159, 8150, 8154, 8159, 8169, 8161, 8149, 8166, 8159, 8162, 8163, 8184, 8182, 8154, 8155, 8146, 8157, 8143, 8147, 8147, 8161, 8165, 8164, 8142, 8139, 8151, 8157, 8140, 8135, 8133, 8149, 8146, 8145, 8151, 8172, 8148, 8141, 8140, 8148, 8166, 8161, 8169, 8176, 8172, 8166, 8153, 8162, 8166, 8165, 8168, 8153, 8159, 8159, 8161, 8163, 8153, 8133, 8133, 8155, 8151, 8154, 8177, 8179, 8165, 8160, 8161, 8162, 8142, 8150, 8149, 8150, 8166, 8171, 8133, 8139, 8155, 8175, 8193, 8165, 8152, 8157, 8147, 8148, 8148, 8160, 8174, 8164, 8147, 8161, 8152, 8141, 8164, 8143, 8139, 8150, 8154, 8165, 8173, 8167, 8155, 8162, 8156, 8180, 8171, 8190, 8182, 8176, 8169, 8176, 8164, 8174, 8172, 8182, 8187, 8176, 8167, 8167, 8157, 8162, 8162, 8166, 8164, 8177, 8157, 8145, 8168, 8159, 8166, 8156, 8150, 8152, 8157, 8151, 8144, 8151, 8150, 8147, 8139, 8157, 8155, 8162, 8146, 8170, 8164, 8154, 8171, 8157, 8149, 8174, 8179, 8184, 8172, 8180, 8173, 8168, 8154, 8146, 8150, 8153, 8179, 8176, 8174, 8156, 8159, 8163, 8160, 8169, 8168, 8177, 8172, 8172, 8194, 8182, 8195, 8201, 8184, 8175, 8164, 8178, 8175, 8148, 8155, 8153, 8146, 8162, 8166, 8167, 8164, 8148, 8131, 8142, 8141, 8135, 8130, 8129, 8124, 8141, 8148, 8161, 8152, 8173, 8170, 8178, 8167, 8154, 8164, 8169, 8165, 8173, 8156, 8168, 8170, 8211, 8197, 8197, 8185, 8205, 8192, 8180, 8195, 8179, 8172, 8184, 8171, 8165, 8152, 8187, 8173, 8150, 8144, 8159, 8155, 8155, 8156, 8158, 8157, 8149, 8159, 8158, 8157, 8169, 8173, 8173, 8160, 8157, 8177, 8184, 8195, 8200, 8192, 8183, 8170, 8157, 8160, 8163, 8155, 8164, 8166, 8181, 8187, 8187, 8177, 8170, 8179, 8157, 8166, 8193, 8209, 8198, 8203, 8209, 8205, 8223, 8228, 8229, 8238, 8208, 8215, 8219, 8190, 8214, 8218, 8234, 8266, 8251, 8241, 8225, 8234, 8204, 8218, 8237, 8227, 8247, 8255, 8270, 8268, 8267, 8283, 8284, 8281, 8287, 8293, 8305, 8294, 8299, 8303, 8326, 8336, 8330, 8349, 8359, 8363, 8370, 8370, 8380, 8394, 8409, 8420, 8446, 8444, 8452, 8449, 8475, 8495, 8514, 8527, 8559, 8578, 8587, 8604, 8673, 8714, 8805, 8920, 9075, 9252, 9495, 9728, 9902, 10015, 10108, 10198, 10229, 10259, 10279, 10265, 10300, 10306, 10307, 10311, 10332, 10311, 10327, 10304, 10305, 10296, 10308, 10311, 10325, 10303, 10319, 10319, 10297, 10317, 10300, 10305, 10317, 10311, 10317, 10322, 10317, 10316, 10316, 10290, 10275, 10285, 10287, 10282, 10297, 10289, 10312, 10304, 10318, 10316, 10302, 10288, 10285, 10295, 10309, 10312, 10331, 10334, 10320, 10282, 10284, 10284, 10276, 10290, 10286, 10279, 10264, 10266, 10288, 10268, 10267, 10266, 10278, 10276, 10277, 10281, 10288, 10299, 10298, 10287, 10301, 10292, 10281, 10276, 10267, 10269, 10248, 10265, 10260, 10280, 10270, 10271, 10292, 10283, 10283, 10276, 10273, 10257, 10275, 10252, 10267, 10273, 10282, 10282, 10276, 10263, 10266, 10255, 10268, 10265, 10282, 10279, 10278, 10269, 10253, 10258, 10265, 10261, 10273, 10245, 10255, 10255, 10235, 10248, 10240, 10228, 10239, 10237, 10225, 10229, 10234, 10259, 10257, 10281, 10256, 10242, 10241, 10245, 10265, 10248, 10236, 10250, 10248, 10258, 10286, 10288, 10269, 10264, 10256, 10237, 10247, 10237, 10219, 10243, 10238, 10258, 10228, 10252, 10239, 10257, 10250, 10258, 10233, 10230, 10213, 10216, 10236, 10235, 10253, 10248, 10238, 10239, 10239, 10219, 10233, 10253, 10261, 10258, 10273, 10281, 10288, 10270, 10279, 10256, 10252, 10247, 10250, 10207, 10211, 10208, 10219, 10195, 10215, 10218, 10226, 10229, 10236, 10228, 10247, 10264, 10251, 10253, 10258, 10227, 10211, 10207, 10218, 10207, 10225, 10231, 10222, 10228, 10210, 10221, 10201, 10201, 10200, 10224, 10239, 10229, 10234, 10241, 10234, 10228, 10220, 10203, 10221, 10239, 10241, 10234, 10228, 10238, 10253, 10236, 10247, 10230, 10224, 10209, 10219, 10214, 10205, 10197, 10198, 10194, 10217, 10199, 10218, 10206, 10205, 10174, 10179, 10181, 10210, 10205, 10232, 10203, 10223, 10214, 10214, 10180, 10196, 10202, 10222, 10202, 10195, 10172, 10179, 10181, 10178, 10181, 10193, 10209, 10201, 10202, 10192, 10195, 10189, 10178, 10205, 10182, 10193, 10168, 10173, 10187, 10184, 10191, 10196, 10223, 10217, 10208, 10209, 10202, 10183, 10171, 10180, 10199, 10200, 10176, 10170, 10173, 10164, 10204, 10193, 10171, 10173, 10156, 10162, 10178, 10165, 10161, 10163, 10188, 10197, 10181, 10182, 10190, 10195, 10166, 10178, 10155, 10176, 10185, 10179, 10179, 10179, 10180, 10165, 10165, 10154, 10162, 10162, 10153, 10173, 10154, 10144, 10137, 10163, 10145, 10143, 10137, 10130, 10162, 10155, 10154, 10169, 10170, 10160, 10140, 10158, 10144, 10154, 10168, 10167, 10192, 10178, 10149, 10166, 10153, 10166, 10167, 10161, 10172, 10183, 10163, 10167, 10159, 10126, 10139, 10152, 10153, 10156, 10150, 10164, 10145, 10122, 10117, 10134, 10131, 10129, 10118, 10170, 10152, 10171, 10155, 10154, 10171, 10186, 10163, 10143, 10126, 10143, 10152, 10139, 10141, 10133, 10150, 10161, 10136, 10122, 10147, 10146, 10147, 10141, 10147, 10148, 10149, 10151, 10140, 10135, 10140, 10120, 10145, 10156, 10153, 10134, 10146, 10148, 10140, 10157, 10145, 10155, 10151, 10127, 10113, 10129, 10139, 10153, 10166, 10163, 10152, 10159, 10155, 10149, 10153, 10157, 10158, 10148, 10115, 10139, 10136, 10161, 10149, 10154, 10142, 10149, 10124, 10134, 10163, 10142, 10155, 10143, 10142, 10164, 10156, 10154, 10146, 10146, 10134, 10148, 10129, 10141, 10114, 10124, 10120, 10113, 10106, 10090, 10101, 10102, 10109, 10116, 10127, 10127, 10112, 10126, 10113, 10127, 10112, 10092, 10108, 10102, 10113, 10102, 10095, 10095, 10101, 10099, 10110, 10112, 10097, 10129, 10110, 10107, 10131, 10120, 10117, 10140, 10130, 10129, 10131, 10115, 10098, 10110, 10110, 10121, 10099, 10081, 10076, 10097, 10100, 10093, 10098, 10099, 10096, 10100, 10074, 10079, 10096, 10102, 10083, 10089, 10088, 10103, 10107, 10105, 10118, 10097, 10100, 10114, 10116, 10114, 10093, 10086, 10088, 10097, 10098, 10106, 10098, 10084, 10105, 10094, 10096, 10092, 10066, 10080, 10086, 10095, 10104, 10101, 10096, 10103, 10104, 10094, 10093, 10092, 10097, 10076, 10089, 10089, 10088, 10099, 10104, 10092, 10066, 10077, 10078, 10064, 10058, 10064, 10084, 10078, 10088, 10089, 10068, 10082, 10085, 10077, 10060, 10051, 10064, 10073, 10083, 10070, 10061, 10088, 10069, 10078, 10068, 10094, 10073, 10062, 10064, 10077, 10065, 10060, 10054, 10092, 10069, 10066, 10081, 10075, 10072, 10057, 10047, 10027, 10050, 10073, 10064, 10073, 10064, 10028, 10047, 10053, 10066, 10056, 10051, 10039, 10052, 10065, 10070, 10069, 10070, 10064, 10059, 10044, 10037, 10050, 10041, 10049, 10058, 10059, 10043, 10042, 10039, 10049, 10054, 10057, 10055, 10061, 10056, 10050, 10050, 10047, 10054, 10066, 10043, 10046, 10040, 10053, 10073, 10078, 10063, 10051, 10062, 10045, 10036, 10036, 10042, 10032, 10029, 10041, 10035, 10049, 10049, 10062, 10041, 10047, 10046, 10044, 10031, 10042, 10032, 10065, 10048, 10041, 10060, 10063, 10060, 10046, 10056, 10040, 10033, 10063, 10050, 10066, 10043, 10048, 10040, 10060, 10081, 10052, 10051, 10039, 10052, 10040, 10060, 10061, 10035, 10045, 10028, 10015, 10022, 10039, 10032, 10046, 10041, 10032, 10044, 10028, 10026, 10026, 10043, 10030, 10037, 10038, 10020, 10033, 10020, 10014, 10012, 9993, 10013, 10033, 10036, 10027, 10031, 10033, 10010, 10017, 10033, 10034, 10054, 10051, 10051, 10025, 10021, 10014, 10029, 10012, 10016, 10031, 10038, 10021, 9995, 9988, 9983, 10003, 10010, 10013, 10000, 10005, 10002, 10000, 9995, 9999, 10015, 10051, 10058, 10023, 10019, 10014, 10030, 10032, 10033, 10049, 10050, 10036, 10023, 10037, 10008, 10015, 10025, 10016, 10022, 9994, 9996, 9996, 9983, 9994, 10006, 10004, 10004, 10003, 9992, 9997, 9976, 9993, 9999, 10011, 10009, 9990, 10006, 10010, 10014, 9996, 9999, 9984, 9997, 9991, 9993, 9998, 10020, 10006, 9988, 9997, 10019, 9996, 9997, 9997, 10015, 10001, 10007, 10008, 10007, 10012, 10003, 9997, 9988, 9966, 9974, 9964, 9954, 9968, 9962, 9972, 9977, 9978, 9981, 9981, 10003, 10007, 10006, 10018, 10017, 9994, 9982, 9976, 9979, 9973, 9977, 9982, 10004, 10008, 9991, 9985, 9982, 9980, 9987, 9969, 9983, 9970, 9964, 9951, 9934, 9937, 9940, 9961, 9954, 9988, 9996, 9975, 10000, 10001, 9987, 10008, 9987, 9981, 9951, 9968, 9962, 9984, 9982, 9968, 9965, 9963, 9966, 9967, 9960, 9965, 9956, 9964, 9958, 9952, 9958, 9956, 9955, 9945, 9964, 9972, 9969, 9936, 9935, 9947, 9951, 9965, 9960, 9985, 9977, 9977, 9979, 9985, 9974, 9979, 9974, 9973, 9945, 9955, 9971, 9964, 9963, 9930, 9938, 9965, 9949, 9948, 9968, 9973, 9968, 9971, 9965, 9966, 9973, 9972, 9979, 9985, 9990]  # fmt: skip


def test_fcio_init():
    fcutils.fcio(ldata.get_path('fcio/th228.fcio'))


def test_fcio_values():
    fc = fcutils.fcio(ldata.get_path('fcio/th228.fcio'))
    assert fc.get_record() == 3

    assert fc.nsamples == 1836
    assert fc.nadcs == 1
    assert fc.telid == 0
    assert fc.ntriggers == 0
    assert fc.adcbits == 16
    assert fc.sumlength == 1
    assert fc.blprecision == 1
    assert fc.mastercards == 0
    assert fc.triggercards == 0
    assert fc.adccards == 1
    assert fc.gps == 0
    assert np.array_equal(fc.traces, np.array([wf_samples], dtype=np.uint16))
    assert np.array_equal(fc.triggertraces, np.empty((0, 1836), dtype=np.uint16))
    assert fc.baseline == [8158]
    assert fc.daqenergy == [8158]
    assert fc.pulser == 0.0
    assert fc.eventtype == 1
    assert fc.numtraces == 1
    assert fc.tracelist == [0]
    assert fc.eventtime == approx(1537868606.5960283)
    assert fc.runtime == approx(0.59602838)
    assert fc.eventnumber == 0
    assert fc.timestamp_pps == 0
    assert fc.timestamp_ticks == 149007095
    assert fc.timestamp_maxticks == 249999999
    assert fc.timeoffset_mu_sec == 1537868606
    assert fc.timeoffset_mu_usec == 220822
    assert fc.timeoffset_master_sec == 1537868606
    assert fc.timeoffset_dt_mu_usec == 220822
    assert fc.timeoffset_abs_mu_usec == 220822
    assert fc.timeoffset_start_sec == 0
    assert fc.timeoffset_start_usec == 0
    assert fc.deadregion_start_pps == 0
    assert fc.deadregion_start_ticks == 0
    assert fc.deadregion_stop_pps == 0
    assert fc.deadregion_stop_ticks == 0
    assert fc.deadregion_maxticks == 249999999
    assert fc.deadtime == 0.0
    assert fc.status == 0
    assert fc.statustime == [0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
    assert fc.cards == 0
    assert fc.size == 0
    assert fc.environment == [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
    assert fc.totalerrors == 0
    assert fc.enverrors == 0
    assert fc.ctierrors == 0
    assert fc.linkerrors == 0
    assert fc.othererrors == [0, 0, 0, 0, 0]
