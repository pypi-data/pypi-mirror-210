input {
  tcp {
    port => 32173
    tags => ['attack']
  }
}

filter {
  if "attack" in [tags] {
    csv {

      separator => "|"
      skip_empty_columns => true
      columns => ["aliases","campaign_id","data_sources","defenses_bypassed","detectable_by_common_defenses","detection","effective_permissions","group","group_description","group_id","impact_type","is_subtechnique","matrix","mitigation","mitigation_description","mitigation_id","mtc_id","permissions_required","platform","remote_support","software","software_description","software_id","subtechnique_of","system_requirements","tactic","tactic_type","technique","technique_description","technique_id","type"]
      skip_header => true
      convert => {
        "detectable_by_common_defenses" => "boolean"
        "is_subtechnique" => "boolean"
      }
    }
    mutate {
      add_field => {
        "[@metadata][helk_parsed]" => "yes"
      }
      remove_field => ["event.original"]
      remove_field => ["message"]
      split => {
        "data_sources" => ", "
        "permissions_required" => ", "
        "aliases" => ", "
        "platform" => ", "
        "tactic" => ", "
        "effective_permissions" => ", "
        "defenses_bypassed" => ", "
      }
    }
  }
}

output {
  if "attack" in [tags] and [@metadata][helk_parsed] == "yes" {
    elasticsearch {
      hosts => ["${ELASTIC_HOST:elasticsearch:9200}"]
      ssl_certificate_verification => false
      index => "mitre-attack-%{+YYYY.MM.dd}"
      user => "${ELASTIC_USER:elastic}"
      password => "${ELASTIC_PWD:changeme}"
    }
    ## For debugging
    # stdout {
    #   codec => rubydebug
    # }
  }
}