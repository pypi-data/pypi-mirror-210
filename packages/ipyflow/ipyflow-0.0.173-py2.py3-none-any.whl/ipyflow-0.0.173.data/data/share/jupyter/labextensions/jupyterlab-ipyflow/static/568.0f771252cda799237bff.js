"use strict";(self.webpackChunkjupyterlab_ipyflow=self.webpackChunkjupyterlab_ipyflow||[]).push([[568],{568:(e,t,n)=>{n.r(t),n.d(t,{default:()=>G});var l=n(501),o=n(225),s=n(897),d=n(761),c=n.n(d);const i="ipyflow",a="waiting-cell",r="ready-cell",u="ready-making-cell",m="ready-making-input-cell",h="linked-waiting",f="linked-ready-maker",y=new Event("cleanup");let v=new Set,_=new Set,C=new Set,w={},p={},g=null,x=null,E={},k={},b={},L=null,S=null,j=!1,A=!1,O=null,V=new Set,q=new Set,N=new Set;function B(){v=new Set,_=new Set,C=new Set,w={},p={},g=null,x=null,E={},k={},b={},L=null,S=null,j=!1,A=!1,O=null,V=new Set,q=new Set,N=new Set}const D={id:"jupyterlab-ipyflow",requires:[s.INotebookTracker,l.ICommandPalette],autoStart:!0,activate:(e,t,n)=>{e.commands.addCommand("alt-mode-execute",{label:"Alt Mode Execute",isEnabled:()=>!0,isVisible:()=>!0,isToggled:()=>!1,execute:()=>{const n=t.currentWidget.sessionContext;n.isReady&&(n.session.kernel.name!==i?(e.commands.execute("notebook:enter-command-mode"),o.CodeCell.execute(t.activeCell,n)):"code"===t.activeCell.model.type&&(e.commands.execute("notebook:enter-command-mode"),A?n.session.kernel.requestExecute({code:"%flow toggle-reactivity-until-next-reset",silent:!0,store_history:!1}).done.then((()=>{n.session.kernel.requestExecute({code:"%flow toggle-reactivity-until-next-reset",silent:!0,store_history:!1}).done.then((()=>{o.CodeCell.execute(t.activeCell,n)}))})):(A=!0,n.session.kernel.requestExecute({code:"%flow toggle-reactivity-until-next-reset",silent:!0,store_history:!1}).done.then((()=>{o.CodeCell.execute(t.activeCell,n)})))))}}),e.commands.addKeyBinding({command:"alt-mode-execute",keys:["Accel Shift Enter"],selector:".jp-Notebook"}),e.commands.addKeyBinding({command:"alt-mode-execute",keys:["Ctrl Shift Enter"],selector:".jp-Notebook"}),n.addItem({command:"alt-mode-execute",category:"execution",args:{}}),e.commands.addCommand("alt-execute",{label:"Alt Execute",isEnabled:()=>!0,isVisible:()=>!0,isToggled:()=>!1,execute:()=>{const n=t.currentWidget.sessionContext;n.isReady&&(e.commands.execute("notebook:enter-command-mode"),o.CodeCell.execute(t.activeCell,n))}}),e.commands.addKeyBinding({command:"alt-execute",keys:["Accel Enter"],selector:".jp-Notebook"}),t.widgetAdded.connect(((e,t)=>{const n=t.sessionContext;n.ready.then((()=>{W(t.content);let e=B;n.session.kernel.name===i&&n.ready.then((()=>{e=F(n,t.content)})),n.kernelChanged.connect(((l,o)=>{null!=o.newValue&&(B(),W(t.content),e(),e=B,o.newValue.name===i&&n.ready.then((()=>{e=F(n,t.content)})))}))}))}))}},I=e=>{if(null==e)return null;const t=e.children.item(1);return null===t?null:t.firstElementChild},K=e=>{if(null==e)return null;const t=e.children.item(2);return null===t?null:t.firstElementChild},M=(e,t,n)=>{const l=()=>{e.removeEventListener(t,n),e.removeEventListener("cleanup",l)};e.addEventListener(t,n),e.addEventListener("cleanup",l)},P=(e,t,n,l,o)=>{null!==e&&null!==t&&M(e,n,(()=>{t.firstElementChild.classList[l](o)}))},T=(e,t)=>{P(I(e),K(e),"mouseover","add",h),P(I(e),K(e),"mouseout","remove",h),P(K(e),I(e),"mouseover","add",t),P(K(e),I(e),"mouseout","remove",t)},R=e=>{E={},k={},b={},e.widgets.forEach(((e,t)=>{E[e.model.id]=e.node,k[e.model.id]=e.model,b[e.model.id]=t}))},W=e=>{e.widgets.forEach((e=>{e.node.classList.remove(a),e.node.classList.remove(u),e.node.classList.remove(r),e.node.classList.remove(m);const t=I(e.node);null!==t&&(t.firstElementChild.classList.remove(h),t.firstElementChild.classList.remove(f),t.dispatchEvent(y));const n=K(e.node);null!==n&&(n.firstElementChild.classList.remove(h),n.firstElementChild.classList.remove(f),n.dispatchEvent(y))}))},z=(e,t,n,l,o,s,d)=>{if(null===e)return;const c=()=>{for(const e of t){let t=f;d.has(e)&&(t=h);const o=l(n[e]);if(null===o||null===o.firstElementChild)return;o.firstElementChild.classList[s](t)}};e.addEventListener(o,c),M(e,o,c)},F=(e,t)=>{B(),g=t.activeCell,x=g.model.id;const n=e.session.kernel.createComm("ipyflow");let l=!1;const s=()=>{const e={};return t.widgets.forEach(((t,n)=>{const l=t.model;e[l.id]={index:n,content:l.sharedModel.getSource(),type:l.type}})),e},d=c().debounce((()=>{l?t.model.contentChanged.disconnect(d):n.send({type:"notify_content_changed",cell_metadata_by_id:s()})}),500),i=e=>{const t=s();n.send({type:"compute_exec_schedule",executed_cell_id:null==e?void 0:e.id,cell_metadata_by_id:t,is_reactively_executing:j})},y=(e,n)=>{l?e.stateChanged.disconnect(y):"executionCount"===n.name&&null!==n.newValue&&(t.widgets.forEach((t=>{t.model.id===e.id&&(t.node.classList.remove(r),t.node.classList.remove(m))})),i(e))},b=e=>{let l=-1;t.widgets.forEach(((t,n)=>{t.model.id===e.id&&(l=n)}));const o={type:"change_active_cell",active_cell_id:e.id,active_cell_order_idx:l};n.send(o)},D=(e,n)=>{if(t===e)if(l)t.activeCellChanged.disconnect(D);else if(b(n.model),null!==g&&null!==g.model&&(g.model.isDirty?v.add(x):v.delete(x),g.model.stateChanged.disconnect(y,g.model.stateChanged)),g=n,x=n.model.id,null!==g&&null!==g.model&&"code"===g.model.type){if(g.model.stateChanged.connect(y),b(g.model),v.has(x)){const e=g.model;void 0!==e._setDirty&&e._setDirty(!0)}R(t),P(x)}};t.activeCellChanged.connect(D);const M=[{action:"mouseover",update:"add"},{action:"mouseout",update:"remove"}],P=e=>{const t=k[e];if("code"!==t.type)return;if(null==t.executionCount)return;const n=E[e];_.has(e)?(n.classList.add(a),n.classList.add(r),n.classList.remove(m),T(n,h)):C.has(e)&&(n.classList.add(m),n.classList.add(r),T(n,f)),"reactive"!==S&&(Object.prototype.hasOwnProperty.call(w,e)&&M.forEach((({action:t,update:l})=>{z(I(n),w[e],E,I,t,l,_),z(K(n),w[e],E,I,t,l,_)})),Object.prototype.hasOwnProperty.call(p,e)&&(_.has(e)||(n.classList.add(u),n.classList.add(r)),M.forEach((({action:t,update:l})=>{z(I(n),p[e],E,I,t,l,_),z(I(n),p[e],E,K,t,l,_)}))))};return n.onMsg=s=>{var c,a;const r=s.content.data;if(!l&&null!==(c=r.success)&&void 0!==c&&c)if("establish"===r.type)t.activeCell.model.stateChanged.connect(y),b(t.activeCell.model),t.model.contentChanged.connect(d),i();else if("set_exec_mode"===r.type)A=!1,S=r.exec_mode;else if("compute_exec_schedule"===r.type){_=new Set(r.waiting_cells),C=new Set(r.ready_cells),q=new Set([...q,...r.new_ready_cells]),N=new Set([...N,...r.forced_reactive_cells]),w=r.waiter_links,p=r.ready_maker_links,L=null;const l=r.exec_mode;j=j||null!==(a=null==r?void 0:r.is_reactively_executing)&&void 0!==a&&a;const s=r.flow_order,d=r.exec_schedule;S=l,O=r.highlights;const c=r.last_executed_cell_id;if(V.add(c),!r.last_execution_was_error){let e=!1;for(const n of t.widgets){if(!e&&(e=n.model.id===c,"in_order"===s||"strict"===d))continue;if("code"!==n.model.type||V.has(n.model.id))continue;if(!q.has(n.model.id))continue;if(!N.has(n.model.id)&&"reactive"!==l)continue;const t=n;if(null===L){if(L=t,"in_order"===s||"strict"===d)break}else null==t.model.executionCount||t.model.executionCount<L.model.executionCount&&(L=t)}}null===L?(j&&("reactive"===O&&(C=V),n.send({type:"reactivity_cleanup"})),N=new Set,q=new Set,V=new Set,(e=>{if(W(e),"none"!==O){R(e);for(const[e]of Object.entries(E))P(e)}})(t),j=!1,"reactive"===S&&(A=!1)):(j=!0,D(t,L),o.CodeCell.execute(L,e))}},n.open({interface:"jupyterlab"}),()=>{l=!0,B()}},G=D}}]);